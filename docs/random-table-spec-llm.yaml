# Random Table JSON Specification v1.0 - LLM Reference
# Purpose: Token-efficient spec for LLM-driven JSON generation
# Schema: https://rolldeo.com/schemas/random-table-spec-v1.0.json

# =============================================================================
# DECISION GUIDE
# =============================================================================
decision_guide:

  table_type:
    simple: "Flat list of items to pick randomly (most tables)"
    composite: "Weighted selection BETWEEN categories, then roll on chosen category"
    collection: "Merge multiple tables into one unified pool"

  composite_vs_collection:
    composite: "Use when text gives percentages/frequencies for categories ('70% common, 25% uncommon, 5% rare')"
    collection: "Use when combining related tables without preference ('any weapon from swords, axes, or polearms')"

  weight_vs_range:
    weight: "Relative probability (weight:3 vs weight:1 = 75%/25%)"
    range: "Explicit dice ranges from source ('[1,50]' = weight 50)"

  template_vs_table:
    table_alone: "Output is picking one item"
    template: "Output combines multiple rolls into formatted text"

  when_to_use:
    extends: "Creating variants, overriding specific entries, disabling entries (weight:0)"
    hidden: "Helper tables not shown in UI but still functional"
    again: "Entry triggers additional rolls on same table"
    shared: "Value rolled once, used multiple times; supports property access"
    sets: "Entries have associated properties beyond display text"

# =============================================================================
# FILE STRUCTURE
# =============================================================================
file_structure:
  required: [metadata, tables]
  optional: [imports, templates, variables, shared]
  minimal: '{"metadata":{"name":"X","namespace":"x.y","version":"1.0.0","specVersion":"1.0"},"tables":[{"id":"t","name":"T","type":"simple","entries":[{"value":"v"}]}]}'

# =============================================================================
# METADATA
# =============================================================================
metadata:
  required:
    name: string
    namespace: {pattern: "publisher.product.category", example: "fantasy.core"}
    version: {pattern: "semver", example: "1.0.0"}
    specVersion: {const: "1.0"}
  optional:
    author: string
    description: {type: string, markdown: true, guidance: "2-5 sentences explaining content, use case, key features"}
    instructions: {type: string, markdown: true}
    tags: {type: "string[]", guidance: "Include: game system, genre, content type, specifics"}
    created: "ISO8601"
    updated: "ISO8601"
  source:
    book: string
    publisher: string
    pages: {examples: ["47", "47-89", "12, 45-67", "Appendix A"]}
    isbn: string
    url: string
    license: {examples: ["OGL 1.0a", "CC BY 4.0", "CC0"]}
    copyright: {simple: string, or_structured: {year: string, holder: string, notice: string}}
  rights:
    type: {enum: [proprietary, open-content, fan-content, licensed]}
    official: {type: boolean, default: false}
    permissions: {commercialUse: false, modification: false, redistribution: false, derivativeWorks: false, attributionRequired: true}
    productIdentity: "string[]"
    trademarks: "string[]"
    contact: {licensing: string, dmca: string}
    termsUrl: string
  engine_config:
    maxRecursionDepth: {default: 50}
    maxExplodingDice: {default: 100}
    maxInheritanceDepth: {default: 5}
    uniqueOverflowBehavior:
      stop: "Return available entries (default)"
      cycle: "Refill pool and continue"
      error: "Throw error"

# =============================================================================
# IMPORTS
# =============================================================================
imports:
  structure:
    path: {required: true, formats: ["./relative.json", "../parent.json", "https://url.com/file.json"]}
    alias: {required: true, constraint: "unique, no periods"}
    description: string
  referencing:
    table: "{{alias.tableId}}"
    template: "{{alias.templateId}}"
    variable: "{{$alias.variableName}}"
    extends: '"extends": "alias.tableId"'
  behavior:
    - "Imports resolved before processing"
    - "Circular imports rejected"
    - "Imported shared blocks are evaluated but variables not available to importer"

# =============================================================================
# TABLES
# =============================================================================
tables:
  common_properties:
    id: {required: true, constraint: "no periods, unique in namespace"}
    name: {required: true}
    type: {required: true, enum: [simple, composite, collection]}
    description: {markdown: true}
    tags: "string[]"
    hidden: {default: false, note: "UI hint only"}
    extends: "parent table ID (supports alias.tableId)"
    defaultSets: "object - key-value pairs for all entries"
    resultType: {case_insensitive: true}
    shared: "table-level generation-time variables (lazy evaluation)"
    source: {book: string, page: "int|string", section: string}

  simple_table:
    entries: {required: true, type: "Entry[]"}

  composite_table:
    desc: "Weighted selection BETWEEN tables, roll once on chosen table"
    sources: [{tableId: {required: true}, weight: {default: 1}}]

  collection_table:
    desc: "Merges all entries from multiple tables"
    collections: {type: "string[]", desc: "tableIds to combine"}

# =============================================================================
# ENTRY PROPERTIES
# =============================================================================
entry:
  id: {optional: true, auto_format: "{tableId}{NNN}", note: "REQUIRED for inheritance overrides"}
  value: {required: true, markdown: true, supports: "{{}} template syntax"}
  weight: {default: 1, min: 0, note: "0 disables entry; mutually exclusive with range"}
  range: {format: "[min, max]", conversion: "weight = max - min + 1"}
  description: {markdown: true, accessed_via: "{{@self.description}}"}
  tags: "string[]"
  sets:
    desc: "key-value pairs for @placeholder access"
    note: "Values can contain {{patterns}} evaluated at selection"
    RESERVED: ["description - use entry's description field instead"]
  assets: {common_keys: [image, token, thumbnail, portrait, sound, music, handout, statblock]}
  resultType: "overrides table resultType"

# =============================================================================
# TEMPLATES
# =============================================================================
template:
  id: {required: true}
  name: {required: true}
  pattern: {required: true, markdown: true}
  description: {markdown: true}
  tags: "string[]"
  resultType: "overrides all table resultTypes"
  shared: "template-level generation-time variables"

# =============================================================================
# TEMPLATE SYNTAX REFERENCE
# =============================================================================
syntax:
  # Table references
  table_roll: "{{tableId}}"
  imported_table: "{{alias.tableId}}"
  multiple: "{{N*tableId}}"
  multiple_unique: "{{N*unique*tableId}}"
  multiple_separator: '{{N*tableId|"sep"}}'
  dice_count: "{{dice:XdY*tableId}}"
  variable_count: "{{$var*tableId}}"
  instance: "{{tableId#instanceName}}"

  # Again (in entry values only, auto-excludes self)
  again: "{{again}}"
  again_n: "{{N*again}}"
  again_unique: "{{N*unique*again}}"
  again_dice: "{{dice:XdY*again}}"
  again_separator: '{{N*again|"sep"}}'

  # Dice
  dice: "{{dice:XdY}}"
  dice_modifiers: "+Z, -Z, *Z"
  dice_keep_high: "{{dice:XdYkN}} or {{dice:XdYkhN}}"
  dice_keep_low: "{{dice:XdYklN}}"
  dice_exploding: "{{dice:XdY!}}"

  # Math
  math: "{{math:expression}}"
  math_operators: "+ - * / (parentheses)"
  math_operands: ["integers", "$variable", "@placeholder.property", "dice:XdY"]
  math_notes:
    - "Integer division rounds toward zero"
    - "Division by zero = 0 with warning"
    - "Non-numeric values coerce to 0"

  # Variables & Placeholders
  variable: "{{$variableName}}"
  imported_variable: "{{$alias.varName}}"
  placeholder: "{{@placeholder.property}}"

  # Self reference
  self_description: "{{@self.description}} - current entry's description field"
  self_value: "{{@self.value}} - current entry's raw value string"
  self_notes: "Returns empty string if undefined; expressions in description are evaluated"

  # Captures
  capture: "{{N*table >> $var}}"
  capture_unique: "{{N*unique*table >> $var}}"
  capture_silent: "{{N*table >> $var|silent}}"
  capture_separator: '{{N*table >> $var|"sep"}}'

  # Capture access
  capture_all: "{{$var}}"
  capture_all_sep: '{{$var|"sep"}}'
  capture_count: "{{$var.count}}"
  capture_index: "{{$var[0]}}"
  capture_negative: "{{$var[-1]}} - last item"
  capture_prop: "{{$var[0].@property}}"

  # Property aggregation
  collect: "{{collect:$var.@prop}}"
  collect_unique: "{{collect:$var.@prop|unique}}"
  collect_separator: '{{collect:$var.@prop|"sep"}}'

  # Switch expressions
  switch_standalone: '{{switch[cond:result].switch[cond2:result2].else[fallback]}}'
  switch_attached: '{{expr.switch[cond:result].else[fallback]}}'
  switch_implicit: "$ in attached switch refers to base expression result"
  switch_operators: ["==", "!=", ">", "<", ">=", "<=", "contains", "matches", "&&", "||", "!", "()"]
  switch_results:
    - '"literal string"'
    - '"interpolated {{$var}} string" - patterns in quotes are evaluated'
    - '$var.@property'
    - '{{tableReference}}'
    - 'tableId (unwrapped, auto-resolved in shared variable context)'
  switch_examples:
    pronoun: '{{switch[$gender=="male":"he"].switch[$gender=="female":"she"].else["they"]}}'
    dice: '{{dice:1d20.switch[$>=20:"Critical!"].switch[$>=10:"Hit"].else["Miss"]}}'
    conditional_text: '{{switch[$danger=="high":"\n\n*Warning!*"].else[""]}}'

  # Escaping
  literal_braces: "\\{{ and \\}}"
  literal_quote_in_separator: '\\"'

# =============================================================================
# VARIABLES
# =============================================================================
variables:
  desc: "Static key-value pairs, evaluated once at file load"
  reference: "{{$variableName}}"
  constraint: "Cannot shadow or conflict with reserved words"

# =============================================================================
# SHARED BLOCK
# =============================================================================
shared:
  document_level:
    desc: "Evaluated once per generation, in declaration order"
    rules:
      - "Cannot shadow static variables"
      - "Cannot forward-reference later shared variables"
      - "Supports dice, table rolls, math, prior shared references"

  table_template_level:
    desc: "Lazy evaluation - only when that table/template is rolled"
    rules:
      - "Propagates to nested table references"
      - "Parent shared takes precedence over child"
      - "Cannot shadow document-level shared"

  property_access:
    desc: "All shared variables capture full result including sets"
    syntax: '"hero": "{{raceTable}}"'
    access_value: "{{$hero}}"
    access_property: "{{$hero.@firstName}}"
    use_case: "Multiple independent instances from same table with isolated placeholder contexts"
    chained_access: "{{$var.@prop1.@prop2}} - works when set values are single table references"

# =============================================================================
# INHERITANCE
# =============================================================================
inheritance:
  syntax: '"extends": "parentTableId"'
  cross_file: '"extends": "alias.tableId"'
  rules:
    - "Only entries with explicit IDs can be overridden"
    - "Single parent only (no diamond)"
    - "Depth limited by maxInheritanceDepth"
    - "Child values override parent"
    - "Tags and resultType NOT inherited"

  property_merge:
    - "Unspecified properties inherited from parent"
    - "assets and sets are deep-merged (child keys override)"
    - "Set property to null to remove inherited value"
    - "defaultSets deep-merged through chain"

  disable_entry: "Override with weight: 0"

# =============================================================================
# RESULT TYPES
# =============================================================================
result_types:
  standard: [creature, npc, faction, item, loot, location, encounter, event, hook, complication, name, trait, effect, environment, ability, description, rumor, dialogue, statistic, number, currency, time, weather]
  custom_format: "namespace/category/type"
  precedence:
    simple: "entry → table → undefined"
    composite: "entry → sourceTable → compositeTable → undefined"
    template: "template.resultType (always wins)"

# =============================================================================
# MARKDOWN SUPPORT
# =============================================================================
markdown:
  enabled_fields: [metadata.description, metadata.instructions, table.description, entry.value, entry.description, template.pattern, template.description]
  supported: ["**bold**", "*italic*", "`code`", "[link](url)", "- bullet", "1. numbered"]
  note: "Template syntax resolved first, then markdown rendered"

# =============================================================================
# VALIDATION
# =============================================================================
validation:
  reserved_words: [dice, unique, again, true, false, null, and, or, not, contains, matches, shared, math]

  identifiers:
    table_id: "alphanumeric+underscore, no digits first, no periods"
    entry_id: "same as table_id; required for inheritance"
    variable: "same as table_id"
    namespace: "dot-separated segments"
    alias: "same as table_id, no periods"

  weight: "Must be >= 0; decimals allowed; 0 disables entry"
  range: "[min, max] where min <= max; mutually exclusive with weight"

  circular_detection:
    - "Import cycles - rejected at load"
    - "Inheritance cycles - rejected at load"
    - "Template cycles - detected at generation"
    - "again auto-excludes self"

# =============================================================================
# COMMON PATTERNS
# =============================================================================
patterns:

  # Sets with child table references - preferred for scalable designs
  sets_based_routing:
    desc: "Each entry contains sets pointing to its own sub-tables"
    table_example: |
      "entries": [
        {"value": "Land", "sets": {"units": "{{landUnits}}", "attacks": "{{landAttacks}}"}},
        {"value": "Sea", "sets": {"units": "{{seaUnits}}", "attacks": "{{seaAttacks}}"}}
      ]
    template_example: |
      "shared": {"$region": "{{region}}"},
      "pattern": "Deploy {{$region.@units}} using {{$region.@attacks}}"
    benefit: "Adding new types = new entries, no template changes"

  # Switch for simple conditionals
  switch_routing:
    when: "2-3 options, simple routing"
    example: '{{switch[$gender=="male":{{maleNames}}].else[{{femaleNames}}]}}'

  # Combining both
  multi_factor:
    desc: "Sets for primary factor, switch for secondary"
    example: |
      "$culture": "{{culture}}",  // has sets: maleNames, femaleNames
      "$name": "{{switch[$gender==\"male\":$culture.@maleNames].else[$culture.@femaleNames]}}"

  # Name generator
  name_generator:
    tables: "[firstNames, lastNames, titles]"
    template: '"{{titles}} {{firstNames}} {{lastNames}}"'
    with_gender: 'Use switch or culture sets with maleNames/femaleNames'

  # Treasure
  treasure:
    simple: '"{{dice:3d6*10}}gp, {{dice:1d4*gems}}"'
    tiered: "Use composite for common/uncommon/rare selection"

  # Encounter
  encounter:
    pattern: '"{{dice:1d4+1}} {{creatures}} in {{location}}"'
    scaled: 'shared: {"$count": "{{dice:2d4}}"}, pattern uses {{$count*monsters}}'

  # Wild magic / roll again
  roll_again: '{"value": "Roll twice! {{2*unique*again|\" AND \"}}", "weight": 1}'

# =============================================================================
# EXAMPLE (MINIMAL)
# =============================================================================
example: |
  {
    "metadata": {
      "name": "Fantasy Encounters",
      "namespace": "fantasy.encounters",
      "version": "1.0.0",
      "specVersion": "1.0",
      "description": "Encounter generator with tiered creatures and treasure.",
      "tags": ["fantasy", "encounters", "creatures"]
    },
    "shared": {
      "encounterSize": "{{dice:1d4+1}}",
      "$leader": "{{eliteCreatures}}"
    },
    "tables": [
      {
        "id": "creatures",
        "name": "Common Creatures",
        "type": "simple",
        "resultType": "creature",
        "defaultSets": {"terrain": "any"},
        "entries": [
          {"id": "goblin", "value": "Goblin", "weight": 5, "sets": {"hp": "{{dice:2d6}}"}},
          {"value": "Wolf", "weight": 3, "sets": {"terrain": "forest"}},
          {"value": "Skeleton", "range": [31, 50]}
        ]
      },
      {
        "id": "eliteCreatures",
        "name": "Elite Creatures",
        "type": "simple",
        "entries": [
          {"value": "Ogre", "sets": {"title": "Brute"}},
          {"value": "Troll", "sets": {"title": "Regenerator"}}
        ]
      },
      {
        "id": "treasure",
        "name": "Treasure",
        "type": "simple",
        "resultType": "loot",
        "entries": [
          {"id": "coins", "value": "{{dice:3d6*10}} gold coins", "weight": 5},
          {"value": "{{dice:1d4}} gemstones", "weight": 2}
        ]
      },
      {
        "id": "allCreatures",
        "name": "All Creatures",
        "type": "collection",
        "collections": ["creatures", "eliteCreatures"]
      }
    ],
    "templates": [
      {
        "id": "encounter",
        "name": "Full Encounter",
        "resultType": "encounter",
        "pattern": "**{{$encounterSize}} {{creatures}}** led by {{$leader.@title}} {{$leader}}.\n\nTreasure: {{$encounterSize*unique*treasure|\", \"}}"
      }
    ]
  }
